limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

upstream auth_service        { server auth-service:3000; }
upstream listing_service     { server listing-service:5000; }
upstream review_service      { server review-service:8000; }
upstream search_service      { server search-service:8004; }
upstream transaction_service { server transaction-service:3001; }
upstream reports_service     { server reports-service:8001; }
upstream wishlist_service    { server wishlist-service:8002; }
upstream analytics_service   { server analytics-service:8003; }
upstream auction_service     { server auction-service:8070; }
upstream chat_service        { server chat-service:8087; }

server {
    listen 80;

    limit_req zone=mylimit burst=20 nodelay;

    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;

    if ($request_method = OPTIONS) {
        return 204;
    }

    location /api/auth/ {
        proxy_pass http://auth_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/listings/ {
        proxy_pass http://listing_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/transactions/ {
        proxy_pass http://transaction_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/admin/transactions/ {
        proxy_pass http://transaction_service/admin/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/admin/fees/ {
        proxy_pass http://transaction_service/admin/fees/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/reviews/ {
        proxy_pass http://review_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/wishlist/ {
        proxy_pass http://wishlist_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/reports/ {
        proxy_pass http://reports_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/analytics/ {
        proxy_pass http://analytics_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/search/ {
        proxy_pass http://search_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/auctions/ {
        proxy_pass http://auction_service/;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/chat/ {
        proxy_pass http://chat_service/;
        proxy_set_header Authorization $http_authorization;
    }
}